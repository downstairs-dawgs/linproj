name: CI
on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run tsc --noEmit
      # Run unit and integration tests (fast, no API rate limit concerns)
      - name: Run unit and integration tests
        run: bun test tests/unit tests/integration
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
      # Run E2E tests with reduced concurrency to avoid API rate limits
      # and retries for flaky network conditions
      - name: Run E2E tests
        run: bun test tests/e2e --preload ./tests/e2e/preload.ts --max-concurrency 5 --retry 2
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}

  release:
    needs: check
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - name: Install UPX
        run: |
          sudo apt-get update
          sudo apt-get install -y upx
      - name: Build binaries
        run: |
          bun build ./src/index.ts --compile --minify --target=bun-darwin-arm64 --outfile linproj-Darwin-arm64
          bun build ./src/index.ts --compile --minify --target=bun-linux-x64 --outfile linproj-Linux-x86_64
          bun build ./src/index.ts --compile --minify --target=bun-linux-arm64 --outfile linproj-Linux-aarch64
      - name: Compress binaries with UPX
        run: |
          upx -9 linproj-Linux-x86_64
          upx -9 linproj-Linux-aarch64
          # macOS UPX binary for debugging (--force-macos produces non-functional executables)
          cp linproj-Darwin-arm64 linproj-Darwin-arm64-upx
          upx -9 --force-macos linproj-Darwin-arm64-upx
      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # strip leading v
          # Extract section between this version and next version header (or EOF)
          NOTES=$(awk "/^## \[${VERSION}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          # Write to file to preserve newlines
          echo "$NOTES" > release-notes.md
      - run: gh release create ${{ github.ref_name }} linproj-* --notes-file release-notes.md
        env:
          GH_TOKEN: ${{ github.token }}
