# Comments: View and Add Comments on Issues

**Date:** 2026-01-26
**Goal:** Enable viewing and adding comments on Linear issues via CLI

## Overview

This design covers commands for interacting with issue comments. Comments are a core collaboration feature in Linear - they allow team members to discuss issues, ask questions, provide updates, and document decisions.

**Design principles:**
1. **Human and AI friendly**: Equally usable by humans at a terminal and AI agents programmatically
2. **Threading support**: First-class support for reply threads, not just flat comment lists
3. **Markdown native**: Comments use markdown - we display it nicely and accept it as input
4. **Quick actions**: Common operations (add comment, react) should be fast one-liners
5. **Scriptable**: JSON output and stdin input for automation workflows

---

## Linear's Comment Model

Understanding Linear's comment structure:

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | Unique identifier (UUID) |
| `body` | string | Comment content in markdown |
| `createdAt` | datetime | When the comment was created |
| `updatedAt` | datetime | Last modification time |
| `editedAt` | datetime | When user manually edited (null if never edited) |
| `url` | string | Direct URL to comment |
| `user` | User | Comment author |
| `parent` | Comment | Parent comment (for replies) |
| `children` | [Comment] | Reply comments |
| `reactions` | [Reaction] | Emoji reactions |
| `reactionData` | object | Reaction summary grouped by emoji |
| `resolvingUser` | User | User who resolved this thread |
| `quotedText` | string | Text being replied to (for inline quotes) |

**Key behaviors:**
- Comments support full markdown
- Comments can be nested (replies to replies)
- Threads can be "resolved" to mark questions answered
- Reactions use standard Unicode emojis

---

## CLI Interface

### List Comments

```bash
# List all comments on an issue
linproj comments ENG-123

# Aliases
linproj issues comments ENG-123

# Output options
linproj comments ENG-123 --json              # JSON output
linproj comments ENG-123 --flat              # Flatten threads (no indentation)
linproj comments ENG-123 --limit 10          # Limit to N comments
```

### Add Comment

```bash
# Quick inline comment
linproj comment ENG-123 "Looking into this now"

# Multiline via stdin (for AI agents and scripting)
cat <<EOF | linproj comment ENG-123
I've investigated the issue. Here's what I found:

## Root Cause
The timeout occurs because...

## Proposed Fix
We should increase the timeout to 60s.
EOF

# Comment from file
linproj comment ENG-123 --file notes.md

# Open editor for longer comments
linproj comment ENG-123 --edit
linproj comment ENG-123 -e

# Reply to a specific comment (threading)
linproj comment ENG-123 "Good idea!" --reply-to <comment-id>

# Reply to the last comment
linproj comment ENG-123 "Agreed" --reply-to last

# Output options
linproj comment ENG-123 "Done" --json        # Return created comment as JSON
linproj comment ENG-123 "Done" --quiet       # Suppress output
linproj comment ENG-123 "Done" --url         # Output only the comment URL
```

### Edit Comment

```bash
# Edit a comment (opens editor)
linproj comment edit <comment-id>

# Edit with new content directly
linproj comment edit <comment-id> "Updated text"

# Edit via stdin
echo "New content" | linproj comment edit <comment-id>
```

### Delete Comment

```bash
# Delete a comment
linproj comment delete <comment-id>

# Skip confirmation
linproj comment delete <comment-id> --yes
```

### Resolve/Unresolve Threads

```bash
# Resolve a comment thread (marks question answered)
linproj comment resolve <comment-id>

# Unresolve a thread
linproj comment unresolve <comment-id>
```

### Reactions

```bash
# Add a reaction to a comment
linproj react <comment-id> :thumbsup:
linproj react <comment-id> +1              # Common aliases
linproj react <comment-id> :rocket:

# Add reaction to an issue (not a comment)
linproj react ENG-123 :eyes:

# Remove a reaction
linproj react <comment-id> :thumbsup: --remove
```

---

## Command Structure

Two entry points for listing comments (both equivalent):

```
linproj comments <issue-id>           # Top-level command
linproj issues comments <issue-id>    # Subcommand of issues
```

For adding/editing/deleting, use the `comment` singular:

```
linproj comment <issue-id> "message"  # Add
linproj comment edit <id>             # Edit
linproj comment delete <id>           # Delete
linproj comment resolve <id>          # Resolve thread
```

Reactions are separate:

```
linproj react <target-id> <emoji>     # Works for comments or issues
```

---

## Input Modes

### 1. Inline Argument (Quick Comments)

```bash
linproj comment ENG-123 "Quick update: PR is ready for review"
```

Best for: Short, single-line comments

### 2. Piped Stdin (AI Agents & Scripts)

```bash
echo "Automated comment from CI" | linproj comment ENG-123

# Or with heredoc for multiline
cat <<EOF | linproj comment ENG-123
## Status Update

Completed the following:
- [x] Fixed the authentication bug
- [x] Added unit tests
- [ ] Pending: documentation update
EOF
```

Best for: AI agents, CI/CD pipelines, scripts

### 3. File Input

```bash
linproj comment ENG-123 --file ./investigation-notes.md
```

Best for: Pre-written content, templates

### 4. Editor Mode

```bash
linproj comment ENG-123 --edit
```

Opens `$EDITOR` with a blank file. On save and close, the content becomes the comment.

Best for: Longer, thoughtful comments requiring editing

**Editor template:**
```markdown
<!-- Comment on ENG-123: Fix authentication timeout -->
<!-- Lines starting with <!-- are removed -->
<!-- Save and close to post. Delete all content to cancel. -->


```

---

## Output Formats

### Default (Human Readable)

```
$ linproj comments ENG-123

ENG-123: Fix authentication timeout
https://linear.app/acme/issue/ENG-123

2 comments:

‚îå‚îÄ Jane Doe ¬∑ 2 hours ago
‚îÇ  Looking into this now. Seems related to the session cleanup PR.
‚îÇ
‚îÇ  ‚îú‚îÄ John Smith ¬∑ 1 hour ago (reply)
‚îÇ  ‚îÇ  Thanks! Let me know if you need help with the session logic.
‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  üëç 2
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ Jane Doe ¬∑ 30 min ago (reply) ‚úì Resolved
‚îÇ     Found the issue - the timeout was 10s instead of 30s.
‚îÇ     Fixed in PR #456.
‚îÇ
‚îî‚îÄ Bot: GitHub ¬∑ 10 min ago
   PR #456 merged into main
```

**Display features:**
- Threaded indentation for replies
- Relative timestamps
- Reactions displayed inline
- "Resolved" badge for resolved threads
- Bot comments labeled

### JSON Output (`--json`)

```json
{
  "issue": {
    "identifier": "ENG-123",
    "title": "Fix authentication timeout",
    "url": "https://linear.app/acme/issue/ENG-123"
  },
  "comments": [
    {
      "id": "comment-uuid-1",
      "body": "Looking into this now. Seems related to the session cleanup PR.",
      "createdAt": "2026-01-26T10:00:00Z",
      "updatedAt": "2026-01-26T10:00:00Z",
      "editedAt": null,
      "url": "https://linear.app/acme/issue/ENG-123#comment-uuid-1",
      "user": {
        "id": "user-uuid-1",
        "name": "Jane Doe",
        "email": "jane@example.com"
      },
      "parentId": null,
      "resolved": false,
      "resolvingUser": null,
      "reactions": [],
      "children": [
        {
          "id": "comment-uuid-2",
          "body": "Thanks! Let me know if you need help with the session logic.",
          "createdAt": "2026-01-26T11:00:00Z",
          "user": {
            "id": "user-uuid-2",
            "name": "John Smith",
            "email": "john@example.com"
          },
          "parentId": "comment-uuid-1",
          "reactions": [
            { "emoji": "üëç", "count": 2 }
          ],
          "children": []
        },
        {
          "id": "comment-uuid-3",
          "body": "Found the issue - the timeout was 10s instead of 30s.\nFixed in PR #456.",
          "createdAt": "2026-01-26T11:30:00Z",
          "user": {
            "id": "user-uuid-1",
            "name": "Jane Doe",
            "email": "jane@example.com"
          },
          "parentId": "comment-uuid-1",
          "resolved": true,
          "resolvingUser": {
            "id": "user-uuid-1",
            "name": "Jane Doe"
          },
          "children": []
        }
      ]
    }
  ],
  "totalCount": 4
}
```

### Flat Mode (`--flat`)

Disables threading, shows comments in chronological order:

```
$ linproj comments ENG-123 --flat

ENG-123: Fix authentication timeout

[1] Jane Doe ¬∑ 2 hours ago
Looking into this now. Seems related to the session cleanup PR.

[2] John Smith ¬∑ 1 hour ago (reply to [1])
Thanks! Let me know if you need help with the session logic.
üëç 2

[3] Jane Doe ¬∑ 30 min ago (reply to [1]) ‚úì Resolved
Found the issue - the timeout was 10s instead of 30s.
Fixed in PR #456.

[4] Bot: GitHub ¬∑ 10 min ago
PR #456 merged into main
```

Useful for: Piping to other tools, simple parsing

---

## GraphQL Operations

### Query: List Comments

```graphql
query IssueComments($issueId: String!, $first: Int) {
  issue(id: $issueId) {
    id
    identifier
    title
    url
    comments(first: $first) {
      nodes {
        id
        body
        createdAt
        updatedAt
        editedAt
        url
        user {
          id
          name
          email
        }
        botActor {
          id
          name
        }
        parent {
          id
        }
        reactionData
        resolvingUser {
          id
          name
        }
      }
    }
  }
}
```

Note: Linear returns comments in a flat list. We build the tree structure client-side using `parent.id`.

### Mutation: Create Comment

```graphql
mutation CreateComment($input: CommentCreateInput!) {
  commentCreate(input: $input) {
    success
    comment {
      id
      body
      createdAt
      url
      user {
        id
        name
      }
    }
  }
}
```

**CommentCreateInput:**
```typescript
interface CommentCreateInput {
  issueId: string;      // Required: issue to comment on
  body: string;         // Required: comment content (markdown)
  parentId?: string;    // Optional: parent comment for replies
}
```

### Mutation: Update Comment

```graphql
mutation UpdateComment($id: String!, $input: CommentUpdateInput!) {
  commentUpdate(id: $id, input: $input) {
    success
    comment {
      id
      body
      updatedAt
      editedAt
    }
  }
}
```

**CommentUpdateInput:**
```typescript
interface CommentUpdateInput {
  body: string;         // New comment content
}
```

### Mutation: Delete Comment

```graphql
mutation DeleteComment($id: String!) {
  commentDelete(id: $id) {
    success
  }
}
```

### Mutation: Create Reaction

```graphql
mutation CreateReaction($input: ReactionCreateInput!) {
  reactionCreate(input: $input) {
    success
    reaction {
      id
      emoji
    }
  }
}
```

**ReactionCreateInput:**
```typescript
interface ReactionCreateInput {
  commentId?: string;   // React to a comment
  issueId?: string;     // OR react to an issue
  emoji: string;        // Unicode emoji
}
```

---

## Implementation

### New Files

```
src/commands/
‚îú‚îÄ‚îÄ comments/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts        # comments command (list)
‚îÇ   ‚îú‚îÄ‚îÄ add.ts          # comment command (add)
‚îÇ   ‚îú‚îÄ‚îÄ edit.ts         # comment edit subcommand
‚îÇ   ‚îú‚îÄ‚îÄ delete.ts       # comment delete subcommand
‚îÇ   ‚îî‚îÄ‚îÄ resolve.ts      # comment resolve/unresolve
‚îú‚îÄ‚îÄ react/
‚îÇ   ‚îî‚îÄ‚îÄ index.ts        # react command
```

### API Functions

**Add to `src/lib/api.ts`:**

```typescript
// Types
export interface Comment {
  id: string;
  body: string;
  createdAt: string;
  updatedAt: string;
  editedAt?: string;
  url: string;
  user?: {
    id: string;
    name: string;
    email: string;
  };
  botActor?: {
    id: string;
    name: string;
  };
  parentId?: string;
  reactionData?: Record<string, number>;
  resolvingUser?: {
    id: string;
    name: string;
  };
}

export interface CommentCreateInput {
  issueId: string;
  body: string;
  parentId?: string;
}

export interface CommentUpdateInput {
  body: string;
}

// Functions
export async function getComments(
  client: LinearClient,
  issueId: string,
  first?: number
): Promise<{ issue: Issue; comments: Comment[] }>;

export async function createComment(
  client: LinearClient,
  input: CommentCreateInput
): Promise<Comment>;

export async function updateComment(
  client: LinearClient,
  commentId: string,
  input: CommentUpdateInput
): Promise<Comment>;

export async function deleteComment(
  client: LinearClient,
  commentId: string
): Promise<boolean>;

export async function resolveComment(
  client: LinearClient,
  commentId: string,
  resolved: boolean
): Promise<Comment>;

export async function createReaction(
  client: LinearClient,
  input: { commentId?: string; issueId?: string; emoji: string }
): Promise<{ id: string; emoji: string }>;

export async function deleteReaction(
  client: LinearClient,
  reactionId: string
): Promise<boolean>;
```

### Tree Building

Comments come flat from the API. Build tree client-side:

```typescript
interface CommentNode extends Comment {
  children: CommentNode[];
}

function buildCommentTree(comments: Comment[]): CommentNode[] {
  const map = new Map<string, CommentNode>();
  const roots: CommentNode[] = [];

  // First pass: create nodes
  for (const comment of comments) {
    map.set(comment.id, { ...comment, children: [] });
  }

  // Second pass: build tree
  for (const comment of comments) {
    const node = map.get(comment.id)!;
    if (comment.parentId && map.has(comment.parentId)) {
      map.get(comment.parentId)!.children.push(node);
    } else {
      roots.push(node);
    }
  }

  // Sort by createdAt
  const sortByDate = (a: CommentNode, b: CommentNode) =>
    new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();

  const sortTree = (nodes: CommentNode[]) => {
    nodes.sort(sortByDate);
    for (const node of nodes) {
      sortTree(node.children);
    }
  };

  sortTree(roots);
  return roots;
}
```

### Emoji Aliases

Map common shorthand to Unicode:

```typescript
const EMOJI_ALIASES: Record<string, string> = {
  '+1': 'üëç',
  '-1': 'üëé',
  'thumbsup': 'üëç',
  'thumbsdown': 'üëé',
  'heart': '‚ù§Ô∏è',
  'rocket': 'üöÄ',
  'eyes': 'üëÄ',
  'tada': 'üéâ',
  'thinking': 'ü§î',
  'check': '‚úÖ',
  'x': '‚ùå',
  'fire': 'üî•',
  'bug': 'üêõ',
  'sparkles': '‚ú®',
};

function resolveEmoji(input: string): string {
  // Remove colons if present
  const key = input.replace(/^:|:$/g, '').toLowerCase();
  return EMOJI_ALIASES[key] || input;
}
```

---

## Error Handling

| Scenario | Error Message | Exit Code |
|----------|---------------|-----------|
| Not authenticated | `Error: Not authenticated. Run 'linproj auth login' first` | 1 |
| Issue not found | `Error: Issue 'ENG-999' not found` | 1 |
| Comment not found | `Error: Comment not found` | 1 |
| Empty comment | `Error: Comment body cannot be empty` | 1 |
| No permission to edit | `Error: You can only edit your own comments` | 1 |
| No permission to delete | `Error: You can only delete your own comments` | 1 |
| Invalid emoji | `Error: Invalid emoji 'notanemoji'` | 1 |
| File not found | `Error: File not found: notes.md` | 1 |
| Editor cancelled | `Comment cancelled` | 0 |

---

## Testing

### Unit Tests

```typescript
describe('buildCommentTree', () => {
  test('builds flat list into tree', () => {
    const comments = [
      { id: '1', body: 'Root', parentId: null },
      { id: '2', body: 'Reply', parentId: '1' },
      { id: '3', body: 'Nested reply', parentId: '2' },
    ];
    const tree = buildCommentTree(comments);
    expect(tree).toHaveLength(1);
    expect(tree[0].children).toHaveLength(1);
    expect(tree[0].children[0].children).toHaveLength(1);
  });

  test('handles multiple root comments', () => {
    const comments = [
      { id: '1', body: 'First', parentId: null },
      { id: '2', body: 'Second', parentId: null },
    ];
    const tree = buildCommentTree(comments);
    expect(tree).toHaveLength(2);
  });

  test('sorts by createdAt', () => {
    const comments = [
      { id: '2', body: 'Later', parentId: null, createdAt: '2026-01-26T12:00:00Z' },
      { id: '1', body: 'Earlier', parentId: null, createdAt: '2026-01-26T10:00:00Z' },
    ];
    const tree = buildCommentTree(comments);
    expect(tree[0].id).toBe('1');
    expect(tree[1].id).toBe('2');
  });
});

describe('resolveEmoji', () => {
  test('resolves aliases', () => {
    expect(resolveEmoji('+1')).toBe('üëç');
    expect(resolveEmoji(':rocket:')).toBe('üöÄ');
    expect(resolveEmoji('heart')).toBe('‚ù§Ô∏è');
  });

  test('passes through unknown', () => {
    expect(resolveEmoji('üéâ')).toBe('üéâ');
    expect(resolveEmoji('unknown')).toBe('unknown');
  });
});
```

### E2E Tests

```typescript
describe('comments list', () => {
  test('lists comments on issue', async () => {
    const result = await runCLI(['comments', 'TEST-123']);
    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('TEST-123');
  });

  test('outputs JSON with --json', async () => {
    const result = await runCLI(['comments', 'TEST-123', '--json']);
    const output = JSON.parse(result.stdout);
    expect(output.comments).toBeDefined();
    expect(Array.isArray(output.comments)).toBe(true);
  });
});

describe('comment add', () => {
  test('adds comment via argument', async () => {
    const result = await runCLI(['comment', 'TEST-123', 'Test comment']);
    expect(result.exitCode).toBe(0);
    expect(result.stdout).toContain('Comment added');
  });

  test('adds comment via stdin', async () => {
    const result = await runCLI(['comment', 'TEST-123'], {
      stdin: 'Comment from stdin'
    });
    expect(result.exitCode).toBe(0);
  });

  test('adds reply to comment', async () => {
    const result = await runCLI([
      'comment', 'TEST-123', 'Reply text',
      '--reply-to', 'comment-uuid'
    ]);
    expect(result.exitCode).toBe(0);
  });

  test('errors on empty comment', async () => {
    const result = await runCLI(['comment', 'TEST-123', '']);
    expect(result.exitCode).toBe(1);
    expect(result.stderr).toContain('cannot be empty');
  });
});

describe('comment edit', () => {
  test('edits comment via argument', async () => {
    const result = await runCLI([
      'comment', 'edit', 'comment-uuid', 'Updated text'
    ]);
    expect(result.exitCode).toBe(0);
  });
});

describe('react', () => {
  test('adds reaction to comment', async () => {
    const result = await runCLI(['react', 'comment-uuid', '+1']);
    expect(result.exitCode).toBe(0);
  });

  test('adds reaction to issue', async () => {
    const result = await runCLI(['react', 'TEST-123', ':rocket:']);
    expect(result.exitCode).toBe(0);
  });
});
```

---

## AI Agent Integration

The comments feature is designed to work seamlessly with AI agents:

### Posting Status Updates

```bash
# AI agent posts investigation results
cat <<EOF | linproj comment ENG-123
## Investigation Complete

I analyzed the authentication timeout issue. Here's what I found:

### Root Cause
The session cleanup cron job runs every 10 seconds, but the session TTL
was set to 10 seconds as well, causing race conditions.

### Recommendation
Increase session TTL to 30 seconds or reduce cleanup frequency.

### Files Examined
- \`src/auth/session.ts:45-67\`
- \`src/cron/cleanup.ts:12-34\`
EOF
```

### Workflow Integration

```bash
# Comment when changing issue state
linproj issues edit ENG-123 --state "In Progress"
linproj comment ENG-123 "Starting work on this issue"

# Or combine in a script
linproj issues start ENG-123 && linproj comment ENG-123 "Picked up this issue"
```

### Reading Comments for Context

```bash
# Get comments as JSON for AI processing
comments=$(linproj comments ENG-123 --json)

# AI can then analyze the discussion and respond appropriately
```

---

## Implementation Order

### Phase 1: List Comments
- [ ] Add Comment types to `src/lib/api.ts`
- [ ] Implement `getComments()` API function
- [ ] Implement tree-building logic
- [ ] Create `src/commands/comments/index.ts`
- [ ] Add human-readable output formatter
- [ ] Add `--json` and `--flat` options
- [ ] Register command and add alias

### Phase 2: Add Comment
- [ ] Implement `createComment()` API function
- [ ] Create `src/commands/comments/add.ts`
- [ ] Support inline argument input
- [ ] Support stdin input
- [ ] Support `--file` input
- [ ] Support `--edit` (editor mode)
- [ ] Support `--reply-to` for threading
- [ ] Add output options (`--json`, `--quiet`, `--url`)

### Phase 3: Edit/Delete Comment
- [ ] Implement `updateComment()` API function
- [ ] Implement `deleteComment()` API function
- [ ] Create edit subcommand
- [ ] Create delete subcommand with confirmation
- [ ] Add ownership validation

### Phase 4: Thread Resolution
- [ ] Implement `resolveComment()` API function
- [ ] Create resolve/unresolve subcommands
- [ ] Update list display to show resolved status

### Phase 5: Reactions
- [ ] Implement `createReaction()` API function
- [ ] Implement `deleteReaction()` API function
- [ ] Create `src/commands/react/index.ts`
- [ ] Add emoji alias resolution
- [ ] Support both comment and issue targets

---

## Future Considerations

- **Notification preferences**: Subscribe/unsubscribe from comment threads
- **Comment search**: Search across comments in a project/team
- **Templates**: Pre-defined comment templates for common updates
- **Attachment support**: Upload files with comments (requires file upload API)
- **Mentions**: `@user` autocomplete when composing in editor mode
- **Inline replies**: Quote specific text when replying (`--quote "text"`)
- **Bulk operations**: Add same comment to multiple issues
- **Watch mode**: Stream new comments in real-time (`linproj comments ENG-123 --watch`)

---

## References

- [Linear API Developers](https://linear.app/developers)
- [Linear Comments Documentation](https://linear.app/docs/comment-on-issues)
- [Linear GraphQL Schema (Apollo Studio)](https://studio.apollographql.com/public/Linear-API/schema/reference)
- [Linear SDK GitHub](https://github.com/linear/linear)
