# Comments: View and Add Comments on Issues

**Date:** 2026-01-26
**Goal:** Enable viewing and adding comments on Linear issues via CLI

## Overview

This design covers commands for interacting with issue comments. Comments are a core collaboration feature in Linear - they allow team members to discuss issues, ask questions, provide updates, and document decisions.

**Design principles:**
1. **Human and AI friendly**: Equally usable by humans at a terminal and AI agents programmatically
2. **Threading support**: First-class support for reply threads, not just flat comment lists
3. **Markdown native**: Comments use markdown - we display it nicely and accept it as input
   - **@mentions**: Linear resolves mentions via plain URLs in comment body. To mention a user, include their profile URL (e.g., `https://linear.app/{workspace}/profiles/{username}`) and Linear converts it to an @mention. Same pattern works for issues. Investigation needed during implementation to confirm behavior with `body` vs `bodyData` fields.
4. **Quick actions**: Common operations (add comment, react) should be fast one-liners
5. **Scriptable**: JSON output and stdin input for automation workflows

---

## Linear's Comment Model

Understanding Linear's comment structure:

| Field | Type | Writable | Description |
|-------|------|----------|-------------|
| `id` | string | read-only | Unique identifier (UUID) |
| `body` | string | **writable** | Comment content in markdown |
| `createdAt` | datetime | read-only | When the comment was created |
| `updatedAt` | datetime | read-only | Last modification time |
| `editedAt` | datetime | read-only | When user manually edited (null if never edited) |
| `url` | string | read-only | Direct URL to comment |
| `user` | User | read-only | Comment author |
| `parent` | Comment | **writable** | Parent comment (for replies) - set via `parentId` on create |
| `children` | [Comment] | read-only | Reply comments |
| `resolvingUser` | User | read-only | User who resolved this thread |
| `quotedText` | string | read-only | Text being replied to (for inline quotes) |

**Key behaviors:**
- Comments support full markdown
- Comments support single-level threading (replies to top-level comments only; attempting to reply to a reply will add to the same thread)
- Threads can be "resolved" to mark questions answered
- Reactions use standard Unicode emojis

---

## CLI Interface

### List Comments

```bash
# List all comments on an issue
linproj issues comments ENG-123

# Output options
linproj issues comments ENG-123 --json       # JSON output
linproj issues comments ENG-123 --limit 10   # Limit to N top-level comments (includes all replies)
```

**`--limit` behavior:** The limit applies to top-level comments only, not total comments. All replies to included top-level comments are shown. This ensures reply threads are never orphaned (a reply without its parent would be confusing). For example, `--limit 5` shows the 5 most recent top-level comments plus all their replies.

### Add Comment

```bash
# Quick inline comment
linproj issues comments add ENG-123 "Looking into this now"

# Multiline via stdin (for AI agents and scripting)
cat <<EOF | linproj issues comments add ENG-123
I've investigated the issue. Here's what I found:

## Root Cause
The timeout occurs because...

## Proposed Fix
We should increase the timeout to 60s.
EOF

# Open editor for longer comments (default when no argument/stdin)
linproj issues comments add ENG-123

# Reply to a specific comment (threading)
linproj issues comments add ENG-123 "Good idea!" --reply-to <comment-id>

# Reply to the last comment (most recent by createdAt)
linproj issues comments add ENG-123 "Agreed" --reply-to last

# Output options (default: outputs comment URL)
linproj issues comments add ENG-123 "Done" --json   # Return created comment as JSON
linproj issues comments add ENG-123 "Done" --quiet  # Suppress output
```

### Edit Comment

```bash
# Edit a comment (opens editor)
linproj issues comment edit <comment-id>

# Edit with new content directly
linproj issues comment edit <comment-id> "Updated text"

# Edit via stdin
echo "New content" | linproj issues comment edit <comment-id>
```

### Delete Comment

```bash
# Delete a comment
linproj issues comment delete <comment-id>

# Skip confirmation
linproj issues comment delete <comment-id> --yes
```

### Resolve/Unresolve Threads

```bash
# Resolve a comment thread (marks question answered)
linproj issues comment resolve <comment-id>

# Unresolve a thread
linproj issues comment unresolve <comment-id>
```

---

## Command Structure

All comment operations are subcommands of `issues`. The command name indicates the expected ID type:
- `comments` (plural) ‚Üí expects an **issue ID**
- `comment` (singular) ‚Üí expects a **comment ID**

```
linproj issues comments <issue-id>             # List comments on issue
linproj issues comments add <issue-id> "msg"   # Add comment to issue
linproj issues comment edit <comment-id>       # Edit a comment
linproj issues comment delete <comment-id>     # Delete a comment
linproj issues comment resolve <comment-id>    # Resolve a comment thread
linproj issues comment unresolve <comment-id>  # Unresolve a comment thread
```

This structure allows for future extension to other commentable objects (e.g., projects) while maintaining a consistent pattern where the command name indicates the ID type expected.

---

## Input Modes

### 1. Inline Argument (Quick Comments)

```bash
linproj issues comments add ENG-123 "Quick update: PR is ready for review"
```

Best for: Short, single-line comments

### 2. Piped Stdin (AI Agents & Scripts)

```bash
echo "Automated comment from CI" | linproj issues comments add ENG-123

# Or with heredoc for multiline
cat <<EOF | linproj issues comments add ENG-123
## Status Update

Completed the following:
- [x] Fixed the authentication bug
- [x] Added unit tests
- [ ] Pending: documentation update
EOF
```

Best for: AI agents, CI/CD pipelines, scripts. For file input, use `cat file.md | linproj issues comments add ENG-123`.

### 3. Editor Mode (Default for Interactive Use)

```bash
linproj issues comments add ENG-123
```

When no inline argument or stdin is provided, opens `$EDITOR` with a blank file. On save and close, the content becomes the comment. Requires a TTY.

Best for: Longer, thoughtful comments requiring editing

**Implementation:** Reuse the existing `defaultOpenEditor()` pattern from `src/commands/issues/edit.ts`:
- Uses `$EDITOR`, falling back to `vim` or `nano`
- Temp file in `os.tmpdir()` with pattern `linproj-comment-{identifier}-{random}.md`
- Cleans up temp file after use

**Editor template:**
```markdown
<!-- Comment on ENG-123: Fix authentication timeout -->
<!-- Lines starting with <!-- are removed -->
<!-- Save and close to post. Delete all content to cancel. -->


```

---

## Output Formats

### Default (Human Readable)

```
$ linproj issues comments ENG-123

ENG-123: Fix authentication timeout
https://linear.app/acme/issue/ENG-123

2 comments:

--- Jane Doe ¬∑ 2 hours ago ---
Looking into this now. Seems related to the session cleanup PR.

  --- John Smith ¬∑ 1 hour ago (reply) ---
  Thanks! Let me know if you need help with the session logic.

  --- Jane Doe ¬∑ 30 min ago (reply) [resolved] ---
  Found the issue - the timeout was 10s instead of 30s.
  Fixed in PR #456.

--- Bot: GitHub ¬∑ 10 min ago ---
PR #456 merged into main
```

**Display features:**
- Simple indentation for replies (2 spaces per level)
- Relative timestamps
- "resolved" badge for resolved threads
- Bot comments labeled
- Comment body printed as-is (preserves markdown formatting)

**Future enhancement:** Integrate with a terminal markdown rendering library (e.g., glamour, glow) to render markdown nicely in the terminal. For now, raw markdown is displayed which works well for simple text but tables/complex formatting may not look ideal.

**Integration with `issues get`**: Comments will be included in `linproj issues get` output by default. For issues with many comments, a truncated summary is shown (e.g., first 3 comments + "X more comments"). Use `--no-comments` to exclude comments from output.

### JSON Output (`--json`)

```json
{
  "issue": {
    "identifier": "ENG-123",
    "title": "Fix authentication timeout",
    "url": "https://linear.app/acme/issue/ENG-123"
  },
  "comments": [
    {
      "id": "comment-uuid-1",
      "body": "Looking into this now. Seems related to the session cleanup PR.",
      "createdAt": "2026-01-26T10:00:00Z",
      "updatedAt": "2026-01-26T10:00:00Z",
      "editedAt": null,
      "url": "https://linear.app/acme/issue/ENG-123#comment-uuid-1",
      "user": {
        "id": "user-uuid-1",
        "name": "Jane Doe",
        "email": "jane@example.com"
      },
      "parentId": null,
      "resolved": false,
      "resolvingUser": null,
      "reactionData": {},
      "children": [
        {
          "id": "comment-uuid-2",
          "body": "Thanks! Let me know if you need help with the session logic.",
          "createdAt": "2026-01-26T11:00:00Z",
          "user": {
            "id": "user-uuid-2",
            "name": "John Smith",
            "email": "john@example.com"
          },
          "parentId": "comment-uuid-1",
          "reactionData": { "üëç": 2 },
          "children": []
        },
        {
          "id": "comment-uuid-3",
          "body": "Found the issue - the timeout was 10s instead of 30s.\nFixed in PR #456.",
          "createdAt": "2026-01-26T11:30:00Z",
          "user": {
            "id": "user-uuid-1",
            "name": "Jane Doe",
            "email": "jane@example.com"
          },
          "parentId": "comment-uuid-1",
          "resolved": true,
          "resolvingUser": {
            "id": "user-uuid-1",
            "name": "Jane Doe"
          },
          "children": []
        }
      ]
    }
  ],
  "totalCount": 4
}
```

---

## GraphQL Operations

### Query: List Comments

```graphql
query IssueComments($issueId: String!, $first: Int) {
  issue(id: $issueId) {
    id
    identifier
    title
    url
    comments(first: $first) {
      nodes {
        id
        body
        createdAt
        updatedAt
        editedAt
        url
        user {
          id
          name
          email
        }
        botActor {
          id
          name
        }
        parent {
          id
        }
        reactionData
        resolvingUser {
          id
          name
        }
      }
    }
  }
}
```

Note: Linear returns comments in a flat list. We build the tree structure client-side using `parent.id`.

### Mutation: Create Comment

```graphql
mutation CreateComment($input: CommentCreateInput!) {
  commentCreate(input: $input) {
    success
    comment {
      id
      body
      createdAt
      url
      user {
        id
        name
      }
    }
  }
}
```

**CommentCreateInput:**
```typescript
interface CommentCreateInput {
  issueId: string;      // Required: issue to comment on
  body: string;         // Required: comment content (markdown)
  parentId?: string;    // Optional: parent comment for replies
}
```

### Mutation: Update Comment

```graphql
mutation UpdateComment($id: String!, $input: CommentUpdateInput!) {
  commentUpdate(id: $id, input: $input) {
    success
    comment {
      id
      body
      updatedAt
      editedAt
    }
  }
}
```

**CommentUpdateInput:**
```typescript
interface CommentUpdateInput {
  body?: string;                  // New comment content
  resolvingUserId?: string | null;  // Set to viewer's ID to resolve, null to unresolve
}
```

### Mutation: Delete Comment

```graphql
mutation DeleteComment($id: String!) {
  commentDelete(id: $id) {
    success
  }
}
```

### Mutation: Resolve/Unresolve Comment

Comment resolution is handled through the `commentUpdate` mutation using the `resolvingUserId` field. The `resolvedAt` timestamp is automatically set by Linear when resolved.

```graphql
mutation ResolveComment($id: String!, $input: CommentUpdateInput!) {
  commentUpdate(id: $id, input: $input) {
    success
    comment {
      id
      resolvedAt
      resolvingUser {
        id
        name
      }
    }
  }
}
```

**To resolve:** Set `resolvingUserId` to the current user's ID.

**To unresolve:** Set `resolvingUserId` to `null`.

```typescript
// Resolve (requires fetching viewer first)
const viewer = await getViewer(client);
await commentUpdate(commentId, { resolvingUserId: viewer.id });

// Unresolve
await commentUpdate(commentId, { resolvingUserId: null });
```

---

## Implementation

### New Files

```
src/commands/issues/
‚îú‚îÄ‚îÄ comments.ts         # issues comments (list) + issues comments add
‚îî‚îÄ‚îÄ comment.ts          # issues comment edit/delete/resolve/unresolve <comment-id>
```

### API Functions

**Add to `src/lib/api.ts`:**

```typescript
// Types
export interface Comment {
  id: string;
  body: string;
  createdAt: string;
  updatedAt: string;
  editedAt?: string;
  url: string;
  user?: {
    id: string;
    name: string;
    email: string;
  };
  botActor?: {
    id: string;
    name: string;
  };
  parentId?: string;
  reactionData?: Record<string, unknown>;  // JSONObject from Linear API, structure varies
  resolvingUser?: {
    id: string;
    name: string;
  };
}

export interface CommentCreateInput {
  issueId: string;
  body: string;
  parentId?: string;
}

export interface CommentUpdateInput {
  body?: string;
  resolvingCommentId?: string | null;
}

// Functions
export async function getComments(
  client: LinearClient,
  issueId: string,
  first?: number
): Promise<{ issue: Issue; comments: Comment[] }>;

export async function createComment(
  client: LinearClient,
  input: CommentCreateInput
): Promise<Comment>;

export async function updateComment(
  client: LinearClient,
  commentId: string,
  input: CommentUpdateInput
): Promise<Comment>;

export async function deleteComment(
  client: LinearClient,
  commentId: string
): Promise<boolean>;

export async function resolveComment(
  client: LinearClient,
  commentId: string,
  resolved: boolean
): Promise<Comment>;
```

### Tree Building

Comments come flat from the API. Build tree client-side:

```typescript
interface CommentNode extends Comment {
  children: CommentNode[];
}

function buildCommentTree(comments: Comment[]): CommentNode[] {
  const map = new Map<string, CommentNode>();
  const roots: CommentNode[] = [];

  // First pass: create nodes
  for (const comment of comments) {
    map.set(comment.id, { ...comment, children: [] });
  }

  // Second pass: build tree
  for (const comment of comments) {
    const node = map.get(comment.id)!;
    if (comment.parentId && map.has(comment.parentId)) {
      map.get(comment.parentId)!.children.push(node);
    } else {
      roots.push(node);
    }
  }

  // Sort by createdAt
  const sortByDate = (a: CommentNode, b: CommentNode) =>
    new Date(a.createdAt).getTime() - new Date(b.createdAt).getTime();

  const sortTree = (nodes: CommentNode[]) => {
    nodes.sort(sortByDate);
    for (const node of nodes) {
      sortTree(node.children);
    }
  };

  sortTree(roots);
  return roots;
}
```

---

## Error Handling

| Scenario | Error Message | Exit Code |
|----------|---------------|-----------|
| Not authenticated | `Error: Not authenticated. Run 'linproj auth login' first` | 1 |
| Issue not found | `Error: Issue 'ENG-999' not found` | 1 |
| Comment not found | `Error: Comment not found` | 1 |
| Empty comment | `Error: Comment body cannot be empty` | 1 |
| No permission to edit | `Error: You can only edit your own comments` | 1 |
| No permission to delete | `Error: You can only delete your own comments` | 1 |

**Note on ownership validation:** Currently, `AuthContext` does not store the current user ID. For edit/delete ownership checks, we need to either:
1. Fetch the current user via `viewer` query each time (adds latency)
2. Cache the user ID in the workspace profile (preferred, future enhancement)

For initial implementation, use option 1 with a `// TODO: cache viewer in workspace profile` comment.
| Editor cancelled | `Comment cancelled` | 0 |

---

## Testing

**Important:** Each implementation phase MUST include both unit tests and E2E tests before the phase is considered complete. E2E tests run against the real Linear API (downstairs-dawgs workspace) to verify end-to-end functionality.

### Test Data Strategy

E2E tests should:
1. Create test issues with comments dynamically when needed
2. Clean up test data after tests complete
3. Use unique identifiers (timestamps) to avoid collisions
4. Handle the case where the test issue may already have comments

### Unit Tests

```typescript
describe('buildCommentTree', () => {
  test('builds flat list into tree', () => {
    const comments = [
      { id: '1', body: 'Root', parentId: null },
      { id: '2', body: 'Reply', parentId: '1' },
      { id: '3', body: 'Nested reply', parentId: '2' },
    ];
    const tree = buildCommentTree(comments);
    expect(tree).toHaveLength(1);
    expect(tree[0].children).toHaveLength(1);
    expect(tree[0].children[0].children).toHaveLength(1);
  });

  test('handles multiple root comments', () => {
    const comments = [
      { id: '1', body: 'First', parentId: null },
      { id: '2', body: 'Second', parentId: null },
    ];
    const tree = buildCommentTree(comments);
    expect(tree).toHaveLength(2);
  });

  test('sorts by createdAt', () => {
    const comments = [
      { id: '2', body: 'Later', parentId: null, createdAt: '2026-01-26T12:00:00Z' },
      { id: '1', body: 'Earlier', parentId: null, createdAt: '2026-01-26T10:00:00Z' },
    ];
    const tree = buildCommentTree(comments);
    expect(tree[0].id).toBe('1');
    expect(tree[1].id).toBe('2');
  });
});
```

### E2E Tests

E2E tests are organized by phase. Each phase's tests must pass before the phase is complete.

#### Phase 1: List Comments E2E (`tests/e2e/issues-comments-list.test.ts`)

```typescript
describe('issues comments list E2E', () => {
  // Setup: Create test issue and add comments in beforeAll
  // Cleanup: Delete test issue in afterAll

  test('lists comments on issue (human-readable)', async () => {
    // Create issue with comments, verify output contains issue identifier and comment content
  });

  test('outputs JSON with --json flag', async () => {
    // Verify JSON structure: { issue: {...}, comments: [...], totalCount: N }
  });

  test('--limit restricts top-level comments', async () => {
    // Create issue with multiple comments, verify --limit works
  });

  test('displays threaded replies correctly', async () => {
    // Create parent comment and reply, verify threading in output
  });

  test('errors on issue not found', async () => {
    // Use nonexistent identifier, verify exit code 1 and error message
  });

  test('shows resolved status for resolved comments', async () => {
    // If possible, test resolved comment display
  });
});
```

#### Phase 2: Add Comment E2E (`tests/e2e/issues-comments-add.test.ts`)

```typescript
describe('issues comments add E2E', () => {
  test('adds comment via inline argument', async () => {
    // Add comment, verify it appears in subsequent list
  });

  test('adds comment via stdin', async () => {
    // Pipe content to add command, verify success
  });

  test('--reply-to creates threaded reply', async () => {
    // Add parent comment, reply to it, verify threading
  });

  test('--reply-to last replies to most recent comment', async () => {
    // Add comments, reply to last, verify parent is correct
  });

  test('--json outputs created comment as JSON', async () => {
    // Verify JSON output structure
  });

  test('--quiet suppresses output', async () => {
    // Verify no stdout on success
  });

  test('errors on empty comment body', async () => {
    // Empty string argument should fail
  });

  test('errors on issue not found', async () => {
    // Nonexistent issue should fail
  });
});
```

#### Phase 3: Edit/Delete Comment E2E (`tests/e2e/issues-comment-edit.test.ts`)

```typescript
describe('issues comment edit E2E', () => {
  test('edits own comment via argument', async () => {
    // Create comment, edit it, verify change
  });

  test('edits own comment via stdin', async () => {
    // Create comment, edit via stdin, verify change
  });

  test('errors on comment not found', async () => {
    // Nonexistent comment ID should fail
  });
});

describe('issues comment delete E2E', () => {
  test('deletes own comment with --yes', async () => {
    // Create comment, delete it, verify gone
  });

  test('errors on comment not found', async () => {
    // Nonexistent comment ID should fail
  });
});
```

#### Phase 4: Resolve/Unresolve E2E (`tests/e2e/issues-comment-resolve.test.ts`)

```typescript
describe('issues comment resolve E2E', () => {
  test('resolves a comment thread', async () => {
    // Create comment, resolve it, verify resolved status in list
  });

  test('unresolves a resolved comment', async () => {
    // Create and resolve comment, unresolve it, verify status
  });

  test('errors on comment not found', async () => {
    // Nonexistent comment ID should fail
  });
});
```

---

## AI Agent Integration

The comments feature is designed to work seamlessly with AI agents:

### Posting Status Updates

```bash
# AI agent posts investigation results
cat <<EOF | linproj issues comments add ENG-123
## Investigation Complete

I analyzed the authentication timeout issue. Here's what I found:

### Root Cause
The session cleanup cron job runs every 10 seconds, but the session TTL
was set to 10 seconds as well, causing race conditions.

### Recommendation
Increase session TTL to 30 seconds or reduce cleanup frequency.

### Files Examined
- \`src/auth/session.ts:45-67\`
- \`src/cron/cleanup.ts:12-34\`
EOF
```

### Reading Comments for Context

```bash
# Get comments as JSON for AI processing
comments=$(linproj issues comments ENG-123 --json)

# AI can then analyze the discussion, filter with jq, and respond appropriately
# Example: get the body of the most recent comment
linproj issues comments ENG-123 --json | jq -r '.comments[-1].body'
```

---

## Implementation Order

### Phase 1: List Comments
- [x] Add Comment types to `src/lib/api.ts`
- [x] Implement `getComments()` API function
- [x] Implement tree-building logic
- [x] Create `src/commands/issues/comments.ts`
- [x] Add human-readable output formatter
- [x] Add `--json` option
- [x] Register `issues comments` subcommand
- [x] Add unit tests for `buildCommentTree()`
- [x] Add E2E tests (`tests/e2e/issues-comments-list.test.ts`)

### Phase 2: Add Comment
- [x] Implement `createComment()` API function (added for e2e test infrastructure)
- [x] Add `add` subcommand to `src/commands/issues/comments.ts`
- [x] Support inline argument input
- [x] Support stdin input
- [x] Support editor mode (default when no argument/stdin and TTY)
- [x] Support `--reply-to` for threading
- [x] Add output options (`--json`, `--quiet`); default outputs URL
- [x] Add E2E tests (`tests/e2e/issues-comments-add.test.ts`)

### Phase 3: Edit/Delete Comment
- [x] Implement `updateComment()` API function
- [x] Implement `deleteComment()` API function (added for e2e test infrastructure)
- [x] Create edit subcommand (`src/commands/issues/comment.ts`)
- [x] Create delete subcommand with confirmation
- [x] Add ownership validation
- [x] Add E2E tests (`tests/e2e/issues-comment-edit.test.ts`)

### Phase 4: Thread Resolution
- [x] Implement `resolveComment()` API function
- [x] Create resolve/unresolve subcommands
- [x] Update list display to show resolved status (was already implemented in Phase 1)
- [x] Add E2E tests (`tests/e2e/issues-comment-resolve.test.ts`)

### Phase 5: Integration with `issues get`
- [x] Add comments to `issues get` output by default
- [x] Implement truncation for issues with many comments (first 3 + "X more")
- [x] Add `--no-comments` flag to `issues get`
- [x] Add E2E tests (`tests/e2e/issues-get-comments.test.ts`)

---

## Future Considerations

- **Reactions**: Emoji reactions on comments and issues (separate design document)
- **Notification preferences**: Subscribe/unsubscribe from comment threads
- **Comment search**: Search across comments in a project/team
- **Templates**: Pre-defined comment templates for common updates
- **Attachment support**: Upload files with comments (requires file upload API)
- **Mentions**: `@user` autocomplete when composing in editor mode
- **Inline replies**: Quote specific text when replying (`--quote "text"`)
- **Bulk operations**: Add same comment to multiple issues
- **Watch mode**: Stream new comments in real-time (`linproj issues comments ENG-123 --watch`)

---

## References

- [Linear API Developers](https://linear.app/developers)
- [Linear Comments Documentation](https://linear.app/docs/comment-on-issues)
- [Linear GraphQL Schema (Apollo Studio)](https://studio.apollographql.com/public/Linear-API/schema/reference)
- [Linear SDK GitHub](https://github.com/linear/linear)
